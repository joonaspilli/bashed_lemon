#!/usr/bin/env bash

submod_bspwm_desktops () {
	local -r STATUS="$1"
	local -r FCS_OCC_COLOR=$(color 'NOTIFY')
	local -r FOCUSED=$(grep -Po '(?<=:(O|F|U)).+?(?=:)' <<< "$STATUS")
	local -r URGENT=$(grep -Poi '(?<=:U).+?(?=:)' <<< "$STATUS")
	local -r OCCUPIED=$(grep -Poi '(?<=:(O|U)).+?(?=:)' <<< "$STATUS")
	local desktops=$(bspc query -D --names)
	local line
	while read line; do
		desktops=$(sed -E "s/\<^$line\$\>/$(notify "\0")/" <<< "$desktops")
	done <<< "$FOCUSED"
	while read line; do
		desktops=$(sed -E "s/\<^$line\$\>/$(alert "\0")/" <<< "$desktops")
	done <<< "$URGENT"
	while read line; do
		desktops=$(\
			sed -E "s/\<^$line\$\>/$(decorate -u "$FCS_OCC_COLOR" "\0")/"\
			<<< "$desktops"\
		)
	done <<< "$OCCUPIED"
	local desktops_line=$(printf '%s' "$desktops" | tr '\n' ' ')
	desktops_line=${desktops_line}
	printf '%s' "$desktops_line"
}

submod_bspwm_focused_monitor () {
	local -r STATUS="$1"
	local -r MONITOR=$(grep -Po '(?<=(W|:)M).+?(?=:)' <<< "$STATUS")
	if (( $(bspc query -M | wc -l) > 1 )); then
		local -r PRIMARY_MONITOR=$(xrandr -q |\
			grep -Po '^.*(?= connected primary)')
		if [[ "$MONITOR" == "$PRIMARY_MONITOR" ]]; then
			print_nothing
		else
			notify "$MONITOR"
		fi
	else
		print_nothing
	fi
}

submod_bspwm_focused_desktops () {
	local -r STATUS="$1"
	local output=$(\
		grep -Po '((?<=:(O|F|U)).+?(?=:))|((?<=:L)T|M(?=:|$))' <<< "$STATUS" |\
		tr '\n' ' '\
	)
	local output="${output%?}"
	[[ -n "$output" ]] && printf '%s' "$output" || print_nothing
}

submod_bspwm_occupied_desktops () {
	local -r STATUS="$1"
	local output=$(\
		grep -Poi '(?<=:(O|U)).+?(?=:)' <<< "$STATUS" |\
		tr '\n' ' '\
	)
	local output="${output%?}"
	[[ -n "$output" ]] && printf '%s' "$output" || print_nothing
}

submod_bspwm_urgent_desktops () {
	local -r STATUS="$1"
	local output=$(\
		grep -Poi '(?<=:U).+?(?=:)' <<< "$STATUS" |\
		tr '\n' ' '\
	)
	local output="${output%?}"
	[[ -n "$output" ]] && alert "URGENT $output" || print_nothing
}

mod_bspwm () {
	local OPTIND arg flag_s flag_c
	while getopts ':s:c' arg; do
		case "$arg" in
			s) flag_s="$OPTARG" ;;
			c) flag_c=1;;
		esac
	done
	shift $((OPTIND-1))
	local -r SEP=${flag_s-$(setting 'MODULE_SEPARATOR')}
	local -r CONCISE=${flag_c:-0}
	local -r PAD=$(setting 'MODULE_PADDING')
	if (( CONCISE )); then
		local -r SUBMODS=(
			submod_bspwm_focused_monitor
			submod_bspwm_desktops
		)
	else
		local -r SUBMODS=(
			submod_bspwm_focused_monitor
			submod_bspwm_focused_desktops
			submod_bspwm_occupied_desktops
			submod_bspwm_urgent_desktops
		)
	fi
	local bspwm_status
	local prev_status
	bspc subscribe report | while read bspwm_status; do
		# Ignore irrelevant changes
		[[ "$bspwm_status" == "$prev_status" ]] && continue
		prev_status="$bspwm_status"
		local line=
		local add_sep=0
		local submod
		for submod in "${SUBMODS[@]}"; do
			local output=$($submod "$bspwm_status")
			[[ "$output" == "$GLOBAL_NOTHING" ]] && continue
			if (( add_sep )); then
				line+="$PAD$SEP$PAD"
			else
				add_sep=1
			fi
			line+="$output"
		done
		print_module "$1" "$line"
	done
}
